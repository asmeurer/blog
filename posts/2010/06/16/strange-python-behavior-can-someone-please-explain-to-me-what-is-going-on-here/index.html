<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns#
        article: http://ogp.me/ns/article#
    " lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Strange Python Behavior (can someone please explain to me what is going on here?) | Aaron Meurer's Blog</title>

    
            <link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

    
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../../rss.xml">

      <link rel="canonical" href="http://asmeurer.github.io/posts/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here/">



    
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"], ['$ latex','$'] ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'left', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script>

        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    
<link rel="stylesheet" type="text/css" href="../../../../../assets/css/tipuesearch.css">
</head>
<body>
<div id="tipue_search_content" style="margin-left: auto; margin-right: auto; padding: 20px;"></div>



    

    <meta name="author" content="Aaron Meurer">
    
        <meta name="og:title" content="Strange Python Behavior (can someone please explain to me what is goin">
        <meta name="og:url" content="http://asmeurer.github.io/posts/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here/">
            <meta name="og:description" content="Every once in a while, seemingly really simple Python code does something completely unexpected for me. Look at the following snippet of Python code.  This is run straight from the 2.6.5 interpreter, ">
        <meta name="og:site_name" content="Aaron Meurer's Blog">
        <meta name="og:type" content="article">

    
        <meta name="twitter:card" content="summary">
            <meta name="twitter:site:id" content="123456">
            <meta name="twitter:creator:id" content="654321">

    





<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://asmeurer.github.io/">Aaron Meurer's Blog</a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li>
<a href="../../../../../archive.html">Archives</a>
                </li>
<li>
<a href="../../../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../../../rss.xml">RSS</a>

            </li>
</ul>
                
<span class="navbar-form pull-left">
<input type="text" id="tipue_search_input">
</span>

            <ul class="nav navbar-nav navbar-right">
                
                
                    
    <li>
    <a href="index.wp" id="sourcelink">Source</a>
    </li>

            </ul>
        </div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container-fluid -->
</nav>

<!-- End of Menubar -->

<div class="container">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <header>
        
    <h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Strange Python Behavior (can someone please explain to me what is going on here?)</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Aaron Meurer</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2010-06-16T04:49:06-05:00" itemprop="datePublished" title="Publication date">2010-06-16 04:49</time></a></p>
                <p class="commentline">
        
    <a href=".#disqus_thread" data-disqus-identifier="cache/posts/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here.html">Comments</a>


        </p>
</div>
        

    </header>

    <div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p></p>
<a href="http://asmeurersympy.wordpress.com/2009/07/20/modifying-a-list-while-looping-through-it-in-python/">Every once in a while</a>, seemingly really simple Python code does something completely unexpected for me. Look at the following snippet of Python code.  This is run straight from the 2.6.5 interpreter, with no other commands executed.  Do you notice anything strange?
<p>[code lan­guage="py"]</p> 
 <p>$python</p> 
 <p>Python 2.6.5 (r265:79359, Mar 24 2010, 01:32:55)  </p> 
 <p>[GCC 4.0.1 (Ap­ple In­c. build 5493)] on dar­win</p> 
 <p>Type "help", "copy­right", "cred­it­s" or "li­cense" for more in­for­ma­tion.</p> 
 <p>&gt;&gt;&gt;; l = lamb­da i: a[i]</p> 
 <p>&gt;&gt;&gt; l</p> 
 <p>&lt;func­tion at="" 0x39e7f0=""&gt;</p> 
 <p>&gt;&gt;&gt; H = [(1, 2), (3, 4)]</p> 
 <p>&gt;&gt;&gt; [l(0) + l(1) for a in H]</p> 
 <p>[3, 7]</p> 
 <p>[/­code]</p> 
 <p>Did you spot it?  Here is a hin­t. Run­ning a dif­fer­ent but sim­i­lar ses­sion:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>$python</p> 
 <p>Python 2.6.5 (r265:79359, Mar 24 2010, 01:32:55)  </p> 
 <p>[GCC 4.0.1 (Ap­ple In­c. build 5493)] on dar­win</p> 
 <p>Type "help", "copy­right", "cred­it­s" or "li­cense" for more in­for­ma­tion.</p> 
 <p>&gt;&gt;&gt; l = lamb­da i: a[i]</p> 
 <p>&gt;&gt;&gt; l</p> 
 <p>&lt;func­tion at="" 0x39e7f0=""&gt;</p> 
 <p>&gt;&gt;&gt; l(0)</p> 
 <p>Trace­back (most re­cent call last):
  File "", line 1, in 
  File "", line 1, in 
NameEr­ror: glob­al name 'a' is not de­fined</p> 
 <p>[/­code]</p> 
 <p>Do you see it now?  I de­fined the lamb­da func­tion  <code>l</code>  in terms of  <code>a</code>  with­out defin­ing first defin­ing  <code>a</code>!  And fur­ther­more, it just works when  <code>a</code>  is de­fined.  This is ac­tu­al­ly in­de­pen­dent of the fact that we are work­ing in a list com­pre­hen­sion, as this con­tin­u­a­tion of the pre­vi­ous ses­sion shows:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>&gt;&gt;&gt; a = [3, 4, 5]</p> 
 <p>&gt;&gt;&gt; l(0)</p> 
 <p>3</p> 
 <p>[/­code]</p> 
 <p>But I want to ex­pand on the list com­pre­hen­sion ex­am­ple, be­cause there even more biz­zare things go­ing on here.  Restart­ing a new ses­sion again:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>$python</p> 
 <p>Python 2.6.5 (r265:79359, Mar 24 2010, 01:32:55)  </p> 
 <p>[GCC 4.0.1 (Ap­ple In­c. build 5493)] on dar­win</p> 
 <p>Type "help", "copy­right", "cred­it­s" or "li­cense" for more in­for­ma­tion.</p> 
 <p>&gt;&gt;&gt; l = lamb­da i: a[i]</p> 
 <p>&gt;&gt;&gt; H = [(1, 2), (3, 4)]</p> 
 <p>&gt;&gt;&gt; [l(0) + l(1) for a in H]</p> 
 <p>[3, 7]</p> 
 <p>&gt;&gt;&gt; (l(0) + l(1) for a in H)</p> 
 <p>&lt;gen­er­a­tor ob­jec­t="" at="" 0x3a4350=""&gt;</p> 
 <p>&gt;&gt;&gt; list((l(0) + l(1) for a in H))</p> 
 <p>[7, 7]</p> 
 <p>[/­code]</p> 
 <p>So, if you are as­tute and have been us­ing Python for long enough, you should be able to catch what is go­ing on here.  If you don't know, here is a hint (con­tin­u­a­tion of pre­vi­ous ses­sion):</p> 
 <p>[code lan­guage="py"]</p> 
 <p>&gt;&gt;&gt; a</p> 
 <p>(3, 4)</p> 
 <p>[/­code]</p> 
 <p>So, as you may know, in Python 2.6 and ear­lier, list com­pre­hen­sion in­dex vari­ables "leek" in­to the lo­cal names­pace.  The strange thing here is that al­though the list com­pre­hen­sion would re­set it, the gen­er­a­tor ver­sion does not.  Well, nor­mal­ly, it does do this:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>&gt;&gt;&gt; x = 1</p> 
 <p>&gt;&gt;&gt; [x for x in range(10)]</p> 
 <p>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</p> 
 <p>&gt;&gt;&gt; x</p> 
 <p>9</p> 
 <p>&gt;&gt;&gt; del x</p> 
 <p>&gt;&gt;&gt; list((x for x in range(10)))</p> 
 <p>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</p> 
 <p>&gt;&gt;&gt; x</p> 
 <p>Trace­back (most re­cent call last):
  File "", line 1, in 
NameEr­ror: name 'x' is not de­fined</p> 
 <p>&gt;&gt;&gt; x = 1</p> 
 <p>&gt;&gt;&gt; list((x for x in range(10)))</p> 
 <p>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</p> 
 <p>&gt;&gt;&gt; x</p> 
 <p>1</p> 
 <p>[/­code]</p> 
 <p>So the above bit has some­thing to do with the way the  <code>lamb­da</code>  func­tion was de­fined with the  <code>a</code>.  By the way, here is what hap­pens with the gen­er­a­tor com­pre­hen­sion (is that what these are called?) if  <code>a</code>  is not de­fined:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>&gt;&gt;&gt; del a</p> 
 <p>&gt;&gt;&gt; list((l(0) + l(1) for a in H))</p> 
 <p>Trace­back (most re­cent call last):
  File "", line 1, in 
  File "", line 1, in 
  File "", line 1, in 
NameEr­ror: glob­al name 'a' is not de­fined</p> 
 <p>[/­code]</p> 
 <p>This is how I dis­cov­ered this.  I had de­fined a lamb­da func­tion us­ing an vari­able that was then passed to a list com­pre­hen­sion that used this vari­able as the in­dex with­out re­al­iz­ing it. But then I tried con­vert­ing this in­to a gen­er­a­tor com­pre­hen­sion to see if it would be faster, and got the above er­ror.   </p> 
 <p>Fi­nal­ly, since the "fea­ture" of leak­ing list com­pre­hen­sion loop vari­ables in­to the lo­cal names­pace is  <a href="http://docs.python.org/release/3.0.1/whatsnew/3.0.html#changed-syntax">go­ing away</a>  in Python 3, I ex­pect­ed things to be­have at least a lit­tle dif­fer­ent­ly in Python 3.  I tried the above in a Python 3.1.2 in­ter­preter and got the fol­low­ing:</p> 
 <p>[code lan­guage="py"]</p> 
 <p>$python3</p> 
 <p>Python 3.1.2 (r312:79147, Mar 23 2010, 22:02:05)  </p> 
 <p>[GCC 4.2.1 (Ap­ple In­c. build 5646) (dot 1)] on dar­win</p> 
 <p>Type "help", "copy­right", "cred­it­s" or "li­cense" for more in­for­ma­tion.</p> 
 <p>&gt;&gt;&gt; l = lamb­da i: a[i]</p> 
 <p>&gt;&gt;&gt; l</p> 
 <p>&lt;func­tion at="" 0x100585a68=""&gt;</p> 
 <p>&gt;&gt;&gt; H = [(1, 2), (3, 4)]</p> 
 <p>&gt;&gt;&gt; [l(0) + l(1) for a in H]</p> 
 <p>Trace­back (most re­cent call last):
  File "", line 1, in 
  File "", line 1, in 
  File "", line 1, in 
NameEr­ror: glob­al name 'a' is not de­fined</p> 
 <p>&gt;&gt;&gt; list((l(0) + l(1) for a in H))</p> 
 <p>Trace­back (most re­cent call last):
  File "", line 1, in 
  File "", line 1, in 
  File "", line 1, in 
NameEr­ror: glob­al name 'a' is not de­fined</p> 
 <p>[/­code]</p> 
 <p>So in Python 3, both the list com­pre­hen­sion and the gen­er­a­tor com­pre­hen­sions act the same, which is not too sur­pris­ing.  I guess I should re­code that piece of code to make it fu­ture proof, al­though this does­n't seem easy at the mo­men­t, and it may re­quire con­vert­ing a one-­lin­er in­to a six-­lin­er.  If you are in­ter­est­ed, the piece of code is  <a href="http://github.com/asmeurer/sympy/blob/15c3675ff67be854c12c349ed9034f12bb2f5247/sympy/integrals/risch.py#L297">here</a>.</p> 
 <p>So can any­one pro­vide any in­sight in­to what is go­ing on with that lamb­da func­tion?  Run­ning it with the  <code>-3</code>  switch to  <code>python2.6</code>  did­n't give any warn­ings re­lat­ed to it.   </p> 
 <p><strong>Up­date:</strong>  As I not­ed in a  <a href="http://asmeurersympy.wordpress.com/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here/#comment-121">com­ment</a>, I fig­ured out how to make this fu­ture-proof.  I need to con­vert it from  </p> 
 <p>[code lan­guage="py"]</p> 
 <p>def residue_re­duce_deriva­tion(H, D, x, t, z):
    lambda­func = lamb­da i: i*deriva­tion(a[1], D, x, t).as_ba­sic().­sub­s(z, i)/ \
         a[1].as_ba­sic().­sub­s(z, i)
    re­turn S(­sum([­Root­Sum(a[0].as_poly(z), lambda­func) for a in H]))
[/­code]</p> 
 <p>to</p> 
 <p>[code lan­guage="py"]</p> 
 <p>def residue_re­duce_deriva­tion(H, D, x, t, z):
    re­turn S(­sum((­Root­Sum(a[0].as_poly(z), lamb­da i: i*deriva­tion(a[1], D, x, t).as_ba­sic().­sub­s(z, i)/ \
        a[1].as_ba­sic().­sub­s(z, i)) for a in H)))
[/­code]</p> 
 <p>Thanks to all the com­menters for the ex­pla­na­tion­s.   </p> 
 <p>Al­so, you may have no­ticed that I dis­cov­ered that if you use  <tt>[code]</tt>  in­stead of  <tt>&lt;code&gt;</tt>, you get these nicer code blocks that  <em>ac­tu­al­ly re­spect in­den­ta­tion!</em>   Now I just need to fig­ure out how to make them syn­tax high­light Python code.</p> 
 <p><strong>Up­date 2:</strong>   <tt>[code='py']</tt>  col­ors it!  Sweet!</p> 
 <p><strong>Up­date 3:</strong>  I just dis­cov­ered that SymPy has a  <code>Lamb­da()</code>  ob­ject that han­dles this bet­ter.  In par­tic­u­lar, it pret­ty prints the code, and is what is al­ready be­ing used for  <code>Root­Sum()</code>  in the ra­tio­nal func­tion in­te­gra­tor, at least in Ma­teusz's polys9.   </p> 
 <p>[code lan­guage="py"]</p> 
 <p>&gt;&gt;&gt; in­te­grate(1/(x**5 + 1), x)</p> 
 <p>log(1 + x)/5 + Root­Sum(625<em>_t<strong>4 + 125*_t</strong>3 + 25</em>_t<em><em>2 + 5</em>_t + 1, Lamb­da(_t, _t</em>log(x + 5*_t)))                                                    </p> 
 <p>[/­code]</p> 
 <p>Stil­l, this has been a very good learn­ing ex­pe­ri­ence.   </p>
</div>
    </div>
    <aside class="postpromonav">
    <nav>
    

    
        <ul class="pager">
            <li class="previous">
                <a href="../../15/a-weeklog/" rel="prev" title="A Weeklog">Previous post</a>
            </li>
            <li class="next">
                <a href="../../26/quick-update/" rel="next" title="Quick Update">Next post</a>
            </li>
        </ul>

    </nav>
    </aside>
        <section class="comments">
        <h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="asmeurer",
            disqus_url="http://asmeurer.github.io/posts/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here/",
        disqus_title="Strange Python Behavior (can someone please explain to me what is going on here?)",
        disqus_identifier="cache/posts/2010/06/16/strange-python-behavior-can-someone-please-explain-to-me-what-is-going-on-here.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section>
    

</article>

        
       <script>var disqus_shortname="asmeurer";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>



        </div>
        <!--End of body content-->

        <footer>
            Contents © 2014         <a href="mailto:asmeurer@gmail.com">Aaron Meurer</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
<p xmlns:dct="http://purl.org/dc/terms/" xmlns:vcard="http://www.w3.org/2001/vcard-rdf/3.0#">
  <a rel="license" href="http://creativecommons.org/publicdomain/zero/1.0/">
    <img src="http://i.creativecommons.org/p/zero/1.0/88x31.png" style="border-style: none;" alt="CC0">
  </a>

        </p></footer>
    </div>
</div>


            <script src="../../../../../assets/js/all-nocdn.js"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script>jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    

<script type="text/javascript" src="../../../../../assets/js/tipuesearch_set.js"></script>
<script type="text/javascript" src="../../../../../assets/js/tipuesearch.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#tipue_search_input').tipuesearch({
        'mode': 'json',
        'contentLocation': '/assets/js/tipuesearch_content.json',
        'showUrl': false
    });
});
</script>


</body>
</html>
