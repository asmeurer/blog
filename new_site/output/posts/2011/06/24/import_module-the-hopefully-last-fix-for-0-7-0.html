<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns#
        article: http://ogp.me/ns/article#
    " lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>import_module (the (hopefully) last fix for 0.7.0) | Aaron Meurer's SymPy Blog</title>

    
            <link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

    
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">

      <link rel="canonical" href="http://asmeurersympy.wordpress.com/posts/2011/06/24/import_module-the-hopefully-last-fix-for-0-7-0.html">



    
        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    


    

    <meta name="author" content="Aaron Meurer">
    
        <meta name="og:title" content="import_module (the (hopefully) last fix for 0.7.0)">
        <meta name="og:url" content="http://asmeurersympy.wordpress.com/posts/2011/06/24/import_module-the-hopefully-last-fix-for-0-7-0.html">
            <meta name="og:description" content="So everything seemed to be ready to go for the 0.7.0 release, when someone pointed out a test failure in Python 2.5.  
It turned out that there is a bug in numpy (see the numpy issue page for more inf">
        <meta name="og:site_name" content="Aaron Meurer's SymPy Blog">
        <meta name="og:type" content="article">

    

    



</head>
<body>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://asmeurersympy.wordpress.com/">Aaron Meurer's SymPy Blog</a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                
                <li>
<a href="../../../../archive.html">Archives</a>
                </li>
<li>
<a href="../../../../categories/index.html">Tags</a>
                </li>
<li>
<a href="../../../../rss.xml">RSS</a>

            </li>
</ul>

            <ul class="nav navbar-nav navbar-right">
                
                
                    
    <li>
    <a href="import_module-the-hopefully-last-fix-for-0-7-0.wp" id="sourcelink">Source</a>
    </li>

            </ul>
        </div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container-fluid -->
</nav>

<!-- End of Menubar -->

<div class="container">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <header>
        
    <h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">import_module (the (hopefully) last fix for 0.7.0)</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Aaron Meurer</span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2011-06-24T06:59:22+00:00" itemprop="datePublished" title="Publication date">2011-06-24 06:59</time></a></p>
                <p class="commentline">
        
    <a href="import_module-the-hopefully-last-fix-for-0-7-0.html#disqus_thread" data-disqus-identifier="cache/posts/2011/06/24/import_module-the-hopefully-last-fix-for-0-7-0.html">Comments</a>


        </p>
</div>
        

    </header>

    <div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p></p>
<p>So everything seemed to be ready to go for the 0.7.0 release, when someone <a href="https://groups.google.com/d/topic/sympy/9FOPjxC0D6s/discussion" target="_blank">pointed out</a> a test failure in Python 2.5.  </p>
<p>It turned out that there is a bug in numpy (see the <a href="http://projects.scipy.org/numpy/ticket/1872" target="_blank">numpy issue page</a> for more information), that was causing the quantum module to fail entirely when imported in Python 2.5 with numpy installed.</p>
<p>Because there was no easy way around the bug, the solution was to disable numpy completely in Python 2.5 in the quantum module.  But this entailed writing the following code idiom</p>
<p>[code language="python"]</p>
<p>import sys</p>
<p>import warnings</p>
<p>numpy_supported = True</p>
<p>if sys.version_info &lt; (2, 6):
    warnings.warn("Cannot use numpy in Python 2.4/2.5.")
    numpy_supported = False
else:
    try:
        import numpy as np
    except ImportError:
        numpy_supported = False
[/code]</p>
<p>in all the half dozen files that import numpy in the quantum module.  </p>
<p>So clearly, SymPy needed a more centralized way to handle importing optional external modules.  Hence, I wrote the <code>import_module()</code> function.  The function attempts to import a module given it's name. It returns the module if it can be imported and None if it cannot.  It supports checking the version of Python or the version of the library and not importing it if either are too old.  It also supports emitting warnings when the module is not available or the version is too old.  Thus, the above idiom reduces to</p>
<p>[code language="python"]</p>
<p>from sympy.external import import_module</p>
<p>np = import_module('numpy', min_python_version=(2, 6))</p>
<p>[/code]</p>
<p>And that's it. The function will automatically warn if numpy cannot be imported because the Python version is too old.</p>
<p>Any kind of <code>numpy_supported</code> variable in the code can be replaced by testing the <code>np</code> variable itself, like</p>
<p>[code language="python"]</p>
<p>if np:
    # Do some numpy stuff
else:
    # np is None
    # Do whatever you do when it is not available
[/code]</p>
<p>This method has an additional advantage, which is that the warnings can be customized by setting variable hooks.  So, for example, the test runner can disable all warnings by doing</p>
<p>[code language="python"]</p>
<p>import sympy.external</p>
<p>sympy.external.importtools.WARN_OLD_VERSION = False</p>
<p>sympy.external.importtools.WARN_NOT_INSTALLED = False</p>
<p>[/code]</p>
<p>I actually did make the test runner do this, and also set both to True when the <code>SYMPY_DEBUG</code> environment variable is set to True (by default, <code>WARN_NOT_INSTALLED</code> is False and <code>WARN_OLD_VERSION</code> is True).</p>
<p>There are some caveats.  First, note that the function does it's magic using the built-in <code><strong>import</strong>()</code> function.  To import a submodule (like <code>sympy.quantum</code>), you need to pass some stuff to the <code>fromlist</code> argument of <code><strong>import</strong>()</code>.  It's also a good idea to pass names to this if you plan to replicate <code>from module import stuff</code> (instead of just <code>import module</code>), because some modules use lazy importing and other magic that prevent you from accessing names directly from <code>module.stuff</code> without importing <code>stuff</code> first.</p>
<p>To do this, just pass the arguments to <code><strong>import</strong>()</code> to <code>import_module()</code> using the <code><strong>import</strong>kwargs</code> keyword argument, like</p>
<p>[code language="python"]</p>
<p>from sympy.external import import_module</p>
<h2>Do this instead of "from matplotlib import pyplot" or "import matplotlib.pyplot as pyplot"</h2>
<p>matplotlib = import_module('matplotlib', <strong>import</strong>kwargs={'fromlist':['pyplot']})</p>
<p>pyplot = matplotlib.pyplot</p>
<p>[/code]</p>
<p>Second, for module version checking it looks at <code>module.<strong>version</strong></code>.  Some modules use a different method (for example, gmpy).  You can use the other method by passing the proper arguments to <code>import_module()</code>.  For example, versions of gmpy lower than 1.03 have a bug that prevent its use in SymPy (basically, <code>int(large mpz)</code> did not automatically convert the number to a <code>long</code>).  So to import gmpy, but only if it's version 1.03 or newer, you would use</p>
<p>[code language="python"]</p>
<p>from sympy.external import import_module</p>
<p>gmpy = import_module('gmpy', min_module_version='1.03',
    module_version_attr='version', module_version_attr_call_args=())
[/code]</p>
<p>This tells it to check the version of gmpy using <code>gmpy.version()</code>, and to import it only if it's at least 1.03 (note that this works by the fact that Python lexicographically compares strings and tuples, so <code>'1.02' &lt; '1.03'</code> returns True).</p>
<p>The sympy.external module is completely independent of the rest of SymPy (it does not call <code>sympy/<strong>init</strong>.py</code>), so you can use it even outside of sympy without the performance penalty that importing all of sympy might bring.  </p>
<p>So, hopefully this is the last issue to fix for the 0.7.0 release.  You can still test it at <a href="https://github.com/sympy/sympy/tree/0.7.0" target="_blank">https://github.com/sympy/sympy/tree/0.7.0</a>.  If people want, I will create another release candidate.  Otherwise, I will release 0.7.0 final on Monday (barring any further problems).</p>
</div>
    </div>
    <aside class="postpromonav">
    <nav>
    

    
        <ul class="pager">
            <li class="previous">
                <a href="../17/fixing-bugs-in-the-release-candidate.html" rel="prev" title="Fixing bugs in the release candidate">Previous post</a>
            </li>
            <li class="next">
                <a href="../29/sympy-0-7-0-released.html" rel="next" title="SymPy 0.7.0 released">Next post</a>
            </li>
        </ul>

    </nav>
    </aside>
        <section class="comments">
        <h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="nikolademo",
            disqus_url="http://asmeurersympy.wordpress.com/posts/2011/06/24/import_module-the-hopefully-last-fix-for-0-7-0.html",
        disqus_title="import_module (the (hopefully) last fix for 0.7.0)",
        disqus_identifier="cache/posts/2011/06/24/import_module-the-hopefully-last-fix-for-0-7-0.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section>
    

</article>

        
       <script>var disqus_shortname="nikolademo";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>



        </div>
        <!--End of body content-->

        <footer>
            Contents © 2014         <a href="mailto:asmeurer@gmail.com">Aaron Meurer</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
        </footer>
    </div>
</div>


            <script src="../../../../assets/js/all-nocdn.js"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script>jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    

</body>
</html>
